<%@page import="java.sql.ResultSet"%>
<%@page import="java.sql.Statement"%>
<%@page import="database.DatabaseConnection"%>
<%@page import="java.sql.Connection"%>
<%@page import="gow_login.RestaurantLogin"%>
<%@page import="java.util.Date"%>
<%@page import="java.util.HashMap"%>
<%@page import="model.ChatMessage"%>
<%@page import="java.util.List"%>
<%@page import="java.util.ArrayList"%>
<%@ page import="java.util.Map" %>
<%@page contentType="text/html" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html lang="en">

<head>
 
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Grub On Wheels</title>
 
  <link rel="stylesheet" href="Resources/Admin/vendors/feather/feather.css"> 
  <link rel="stylesheet" href="Resources/style.css">
  
  <link rel="stylesheet" href="Resources/Admin/vendors/ti-icons/css/themify-icons.css">
  
  <link rel="stylesheet" href="Resources/Admin/css/vertical-layout-light/style.css">
  
  <style>
  .chat-tab {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #3498db;
    color: #fff;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
}

.chat-box {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 300px;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 5px;
}

.chat-header {
    background-color: #3498db;
    color: #fff;
    padding: 10px;
    border-top-left-radius: 5px;
    border-top-right-radius: 5px;
}

.chat-messages {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 200px;
    overflow-y: auto;
}

.chat-form {
    padding: 10px;
    border-top: 1px solid #ccc;
}
  </style>
  
</head>
<body>

  <div class="container-scroller">
    
    <nav class="navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row" >
      <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center">
          <a class="navbar-brand brand-logo mr-5" href="#"><img src="Resources/Admin/images/admin.svg" class="mr-2" alt="logo"/></a>
        <a class="navbar-brand brand-logo-mini" href="#"><img src="Resources/Admin/images/admin.png" alt="logo"/></a>
      </div>
      <div class="navbar-menu-wrapper d-flex align-items-center justify-content-end">
        <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
          <span class="icon-menu"></span>
        </button>
        <ul class="navbar-nav mr-lg-2">
          <li class="nav-item nav-search d-none d-lg-block">
            <div class="input-group">
              <div class="input-group-prepend hover-cursor" id="navbar-search-icon">
              </div>
                 <center> <h2 style="color: #FF7F50; margin-left: 200px">Grub On WheelsðŸšš</h2></center>
            </div>
          </li>
        </ul>
        <ul class="navbar-nav navbar-nav-right">
          <li class="nav-item nav-profile dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" id="profileDropdown">
     <i class="icon-lock"></i>
            </a>
            <div class="dropdown-menu dropdown-menu-right navbar-dropdown" aria-labelledby="profileDropdown">
                <a class="dropdown-item" href="restaurantLogout.jsp">
                <i class="ti-power-off text-primary"></i>
                Logout
              </a>
            </div>
          </li>
        </ul>
      </div>
    </nav>
    
    <div class="container-fluid page-body-wrapper">
      
      <nav class="sidebar sidebar-offcanvas" id="sidebar" >
                    <ul class="nav">
                        <li class="nav-item">
                            <a class="nav-link active" href="restaurantHome.jsp">
                                <i class="icon-grid menu-icon"></i>
                                <span class="menu-title">Dashboard</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="addMenu.jsp">
                                <i class="ti-user menu-icon"></i>
                                <span class="menu-title">Add Menu</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="updateMenu.jsp">
                                <i class="ti-user menu-icon"></i>
                                <span class="menu-title">Menu Update</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="restaurantOrders.jsp">
                                <i class="ti-user menu-icon"></i>
                                <span class="menu-title">Orders</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="restaurantTransactions.jsp">
                                <i class="ti-money menu-icon"></i>
                                <span class="menu-title">Transactions</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="restaurantComplaints.jsp">
                                <i class="icon-mail menu-icon"></i>
                                <span class="menu-title">Reviews</span>
                            </a>
                        </li>
                    </ul>
                </nav>
      
      <div class="main-panel">
        <div class="content-wrapper" style="background-color: gold">
          <div class="row">
            <div class="col-md-12 grid-margin">
              <div class="row">
                <div class="col-12 col-xl-8 mb-4 mb-xl-0">
                
                  <h3 class="font-weight-bold">Heyyy! Up with any delicious stuff?</h3>
                  
                  <h6 class="font-weight-normal mb-0">Customers are waiting for you!</h6>
                  
                </div>
                <div class="col-12 col-xl-4">
                 <div class="justify-content-end d-flex">
                  <div class="dropdown flex-md-grow-1 flex-xl-grow-0">
                    <button class="btn btn-sm btn-light bg-white" type="button"   aria-haspopup="true" aria-expanded="true">
                     <i class="mdi mdi-calendar"></i> <%Date date = new Date();%> <%=date.toString()%>
                    </button>
                  </div>
                 </div>
                </div>
              </div>
            </div>
          </div>
          <br><br>
         
          <%String restid = (String)session.getAttribute("restid"); 
          
            /* int totalOrders = orderBean.getTotalOrders(session);
            int totalRevenue = orderBean.getTotalRevenue(session); */
          Connection conn = DatabaseConnection.getconnection();
          Statement stmt = conn.createStatement();
          Statement stmt1 = conn.createStatement();
          Statement stmt2= conn.createStatement();
          int totalMenu=0;;
          int totalOrders=0;
          int totalRevenue=0;
          try{
          ResultSet rs = stmt.executeQuery("Select count(dishname) as totmenu from restaurant_menu where restid='"+restid+"'");
          ResultSet rs1 = stmt1.executeQuery("Select count(oid) as totOrder from gow.useroders uo where DATE(STR_TO_DATE(uo.`time`,'%d/%m/%Y %H:%i:%s'))=CURDATE() and resid = '"+restid+"'");
          ResultSet rs2 = stmt2.executeQuery("Select sum(price) as totPrice from gow.useroders uo where DATE(STR_TO_DATE(uo.`time`,'%d/%m/%Y %H:%i:%s'))=CURDATE() and orderstatus='Confirmed' and resid = '"+restid+"'");
         if(rs.next() && rs1.next() && rs2.next()){
          totalMenu = rs.getInt("totmenu");
          totalOrders = rs1.getInt("totOrder");
          totalRevenue = rs2.getInt("totPrice");
         }
          %>
          <div>
           <!-- ...... -->
           <div class="resthomebox">
  <p style="color:white; text-align:center;font-size: larger;"><strong>Total Menus</strong></p>
  <p class="flipX" style="color:white; text-align:center;font-size: large;"><strong><%=totalMenu %></strong></p>
  <!-- <div class="progress-bar1">
    <div class="progress1" id="progress"></div>
    <div class="progress-label1"><span style="margin-left: 15px">0%</span>
      <span>100%</span></div>
  </div> -->
  </div>
  <div class="resthomebox" style="margin-left:30px">
  <p style="color:white; text-align:center;font-size: larger;"><strong>Total Orders</strong></p>
  <p class="flipX" style="color:white; text-align:center;font-size: large;"><strong><%=totalOrders %></strong></p>
  <!-- <div class="progress-bar1">
    <div class="progress1" id="progress1"></div>
    <div class="progress-label1"><span style="margin-left: 15px">0%</span>
      <span>100%</span></div>
  </div> -->
</div>
<%-- <div class="resthomebox" style="margin-left:30px">
  <p style="color:white; text-align:center;font-size: larger;"><strong>Total Revenue</strong></p>
  <p class="flipX" style="color:white; text-align:center;font-size: large;"><strong>Â£<%=totalRevenue %></strong></p>
   </div> --%>        
          </div>
         
          
        </div>
        
        <footer class="footer">
          <div class="d-sm-flex justify-content-center justify-content-sm-between">
            <span class="text-muted text-center text-sm-left d-block d-sm-inline-block">Copyright Â© 2023 All rights reserved.</span>
          </div>
        </footer>
        
      </div>
      
    </div>
    
  </div>
 
<%
          }
          catch(Exception e){
        		e.printStackTrace();	
        	} finally{
        		stmt.close();
        		stmt1.close();
        		stmt2.close();
        		conn.close();
        	} %>

   <div id="chatTab" class="chat-tab">
    Chat
</div>
<% List<ChatMessage> chatHistory = new ArrayList<ChatMessage>();
Map<String, List<ChatMessage>> userChatHistories = new HashMap<String, List<ChatMessage>>();
userChatHistories = (Map<String, List<ChatMessage>>) session.getAttribute("userChatHistories");
chatHistory = (ArrayList<ChatMessage>) session.getAttribute("interactedUser");%>
<div id="chatBox" class="chat-box">
    <div class="chat-header" style="display: none">Chat History</div>
    <ul class="chat-messages" style="display: none">
        <c:forEach var="message" items="<%=session.getAttribute(\"chatHistory\") %>">
            <li>${message.sender}: ${message.message}</li>
        </c:forEach>
    </ul>
    <form action="RestaurantChat" method="post" class="chat-form" style="display: none">
        <input type="hidden" name="sender" value="${restaurant.restaurantName}">
        <input type="text" name="message" placeholder="Enter your message">
        <input type="hidden" name="selectedUser" id="selectedUser">
        <input type="hidden" name="restid" value="${restaurant.restaurantID}">
        <input type="submit" value="Send">
    </form>
    
    <div class="interacted-users" id="interactedUsers">
        <h3>Interacted Users</h3>
        <ul>
            <c:forEach var="entry" items="<%=userChatHistories%>">
            <c:set var="userMessages" value="${entry.value}" />
                <li><a href="javascript:void(0);" class="user-link" data-user-id="${entry.key}">
                <strong>${userMessages[0].sender}</strong>
                </a></li>
            </c:forEach>
        </ul>
    </div>
</div>

<script>
   
    const chatTab = document.getElementById("chatTab");
    const chatBox = document.getElementById("chatBox");
    const userLinks = document.querySelectorAll(".user-link");
    const chatMessages = document.querySelector(".chat-messages");
    const chatForm = document.querySelector(".chat-form");
    const chatHeader = document.querySelector(".chat-header");
    const selectedUserIDInput = document.getElementById("selectedUser");

    chatTab.addEventListener("click", () => {
        chatBox.style.display = chatBox.style.display === "block" ? "none" : "block";
    });

    userLinks.forEach(userLink => {
        userLink.addEventListener("click", () => {
        	const selectedUserID = userLink.getAttribute("data-user-id");
            userLinks.forEach(link => link.classList.remove("active"));
            userLink.classList.add("active");
            chatBox.style.display = "block";
            selectedUserIDInput.value = selectedUserID;
            fetchChatHistory(selectedUserID);
            chatMessages.style.display = "block";
            chatForm.style.display = "block";
            chatHeader.style.display = "block";
        });
    });

    function fetchChatHistory(userID){
    	const chatMessages = document.querySelector(".chat-messages");
        chatMessages.innerHTML = ""; // Clear existing chat messages
        const url = 'http://localhost:8080/GrubOnWheels/ChatHistoryServlet'
        
        	const data = {
                selUserID: userID
            };
        // Make an AJAX request to fetch the chat history
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            chatMessages.innerHTML = ""; 
            data.forEach(message => {
                const messageElement = document.createElement("li");
                messageElement.textContent = message.sender + ": " + message.message;
                chatMessages.appendChild(messageElement);
            });
        })
        .catch(error => {
            console.error("Error fetching chat history:", error);
        });
            
        }
    
</script>
   
  
  <script src="Resources/Admin/vendors/js/vendor.bundle.base.js"></script>
  <script src="Resources/Admin/js/hoverable-collapse.js"></script>
  <script src="Resources/Admin/js/template.js"></script>

</body>
</html>
