package gow_register;

import java.io.IOException;
import java.sql.Connection;
import database.DatabaseConnection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

@WebServlet("/UserRegister")
public class UserRegister extends HttpServlet{

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;

	protected void registerUser(HttpServletRequest req, HttpServletResponse res) throws ServletException,IOException 
	{
		res.setContentType("text/html;charset=UTF-8");
		try {
		//PrintWriter pw = res.getWriter();
		HttpSession session = req.getSession();
		String name = req.getParameter("name");
		String lname = req.getParameter("lname");
		String email = req.getParameter("email");
		String phone = req.getParameter("phone");
		String password1 = req.getParameter("password");
		String password2 = req.getParameter("cpassword");
		if(password1.equals(password2)) {
			System.out.println("Password match!");
		
		int selectCount = 0;
		int insertCount=0;
		Connection conn = DatabaseConnection.getconnection();
		PreparedStatement ptst;
		Statement stmt = conn.createStatement();
		try {
			ResultSet resultSet = stmt.executeQuery("SELECT * FROM gow.users where phone = '"+phone+"'");
			while(resultSet.next()) {
				selectCount++;
			}
			if(selectCount>0) {
				System.out.println("Phone Number Already Exist!!!");
				res.sendRedirect("userLogin.jsp?phone");
			}
			else {
				ptst = conn.prepareStatement("insert into users(name, lname, mailid, phone, pass) values('" + name + "','" +lname+ "','" + email + "','" + phone + "','" + password1 + "') ");
				insertCount = ptst.executeUpdate();
				if(insertCount>0) {
					res.sendRedirect("userLogin.jsp?success");
				}
				else {
					String error = "User Not Registered! Please try again";
					req.setAttribute("error1", error);
					RequestDispatcher rd = req.getRequestDispatcher("/userSignup.jsp");
		            rd.forward(req, res); 
				}
			}
		}catch (SQLException e) {
			// TODO: handle exception
			e.printStackTrace();
		}
		}
		else {
			session.invalidate();
			String error = "Passwords do not match!!!";
			req.setAttribute("error", error);
			RequestDispatcher rd = req.getRequestDispatcher("/userSignup.jsp");
            rd.forward(req, res); 
		}
		}
		 catch (Exception e) {
			// TODO: handle exception
			e.printStackTrace();
		}
	}

	@Override
	protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		// TODO Auto-generated method stub
		registerUser(req, resp);
	}

	@Override
	protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		// TODO Auto-generated method stub
		registerUser(req, resp);
	}
}