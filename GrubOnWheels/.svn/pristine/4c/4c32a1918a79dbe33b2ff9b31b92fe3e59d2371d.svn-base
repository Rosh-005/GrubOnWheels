package servlet;

import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import model.ChatMessage;
import model.Restaurant;
import model.User;

@WebServlet("/RestaurantChat")
public class RestaurantChat extends HttpServlet{

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;
	
	private Map<String, List<ChatMessage>> restaurantChatHistories = new HashMap<>();
	 private Map<String, User> users = new HashMap<>();

    protected void doGet(HttpServletRequest request, HttpServletResponse response, String userRestaurantID)
            throws ServletException, IOException {
        HttpSession session = request.getSession();
        String selectedUser = request.getParameter("userid");
        Restaurant restaurant = (Restaurant) session.getAttribute("restaurant");

        List<ChatMessage> chatHistory = new ArrayList<ChatMessage>();
        chatHistory = restaurantChatHistories.get(userRestaurantID);
        if (chatHistory == null) {
            chatHistory = new ArrayList<>();
            restaurantChatHistories.put(userRestaurantID, chatHistory);
        }

        request.setAttribute("chatHistory", chatHistory);
        request.setAttribute("restaurant", restaurant);
        session.setAttribute("restaurantChat", chatHistory);
        session.setAttribute("restaurantChatHistories", restaurantChatHistories);
        session.setAttribute("userRestaurantID", userRestaurantID);

        response.sendRedirect("restaurantHome.jsp");
    }

    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
    	HttpSession session = request.getSession();
        String sender = request.getParameter("sender");
        String message = request.getParameter("message");
        String userRestaurant = request.getParameter("selectedUser");

        List<ChatMessage> chatHistory = new ArrayList<ChatMessage>();
        chatHistory = restaurantChatHistories.get(userRestaurant);
        if (chatHistory == null) {
            chatHistory = new ArrayList<>();
            restaurantChatHistories.put(userRestaurant, chatHistory);
        }

        chatHistory.add(new ChatMessage(sender, message));
        doGet(request, response, userRestaurant);
    }
}
